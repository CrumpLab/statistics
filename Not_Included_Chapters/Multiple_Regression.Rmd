# Multiple and logistic regression {#multipleRegressionAndANOVA}

[multipleAndLogisticRegression]

The principles of simple linear regression lay the foundation for more sophisticated regression methods used in a wide range of challenging settings. In Chapter [multipleAndLogisticRegression], we explore multiple regression, which introduces the possibility of more than one predictor, and logistic regression, a technique for predicting categorical outcomes with two possible categories.

## Introduction to multiple regression {#introductionToMultipleRegression}

Multiple regression extends simple two-variable regression to the case that still has one response but many predictors (denoted $x_1$, $x_2$, $x_3$, ...). The method is motivated by scenarios where many variables may be simultaneously connected to an output.

We will consider Ebay auctions of a video game called *Mario Kart* for the Nintendo Wii. The outcome variable of interest is the total price of an auction, which is the highest bid plus the shipping cost. We will try to determine how total price is related to each characteristic in an auction while simultaneously controlling for other variables. For instance, all other characteristics held constant, are longer auctions associated with higher or lower prices? And, on average, how much more do buyers tend to pay for additional Wii wheels (plastic steering wheels that attach to the Wii controller) in auctions? Multiple regression will help us answer these and other questions.

The data set includes results from 141 auctions.[^7.1] Four observations from this data set are shown in Table [marioKartDataMatrix], and descriptions for each variable are shown in Table [marioKartVariables]. Notice that the condition and stock photo variables are indicator variables. For instance, the variable takes value 1 if the game up for auction is new and 0 if it is used. Using indicator variables in place of category names allows for these variables to be directly used in regression. See Section [categoricalPredictorsWithTwoLevels] for additional details. Multiple regression also allows for categorical variables with many levels, though we do not have any such variables in this analysis, and we save these details for a second or third course.

<span>rrrrlr</span> & price & cond\_

new & stock\_

photo & duration & wheels\
1 & 51.55 & 1 & 1 & 3 & 1\
2 & 37.04 & 0 & 1 & 7 & 1\
$\vdots$ &$\vdots$ &$\vdots$ &$\vdots$ &$\vdots$ &$\vdots$\
140 & 38.76 & 0 & 0 & 7 & 0\
141 & 54.51 & 1 & 1 & 1 & 2\

[marioKartDataMatrix]

  <span>**variable**</span>   <span>**description**</span>
  --------------------------- --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
  **price**                   final auction price plus shipping costs, in US dollars
                              a coded two-level categorical variable, which takes value when the game is new and if the game is used
                              a coded two-level categorical variable, which takes value if the primary photo used in the auction was a stock photo and if the photo was unique to that auction
  **duration**                the length of the auction, in days, taking values from 1 to 10
  **wheels**                  the number of Wii wheels included with the auction (a *Wii wheel* is a plastic racing wheel that holds the Wii controller and is an optional but helpful accessory for playing Mario Kart)

  : Variables and their descriptions for the data set.

[marioKartVariables]

### A single-variable model for the Mario Kart data {#twoSingleVariableModelsForMarioKartData}

Let’s fit a linear regression model with the game’s condition as a predictor of auction price. The model may be written as

$$\begin{aligned}
\widehat{price} &= 42.87 + 10.90\times cond\_\hspace{0.3mm}new\end{aligned}$$

Results of this model are shown in Table [singleVarModelsForPriceUsingCond] and a scatterplot for price versus game condition is shown in Figure [marioKartSingle].

<span>rrrrr</span>

& & & &\
& Estimate & Std. Error & t value & Pr($>$$|$t$|$)\

& & & &\
(Intercept) & 42.8711 & 0.8140 & 52.67 & 0.0000\
cond\_

new & 10.8996 & 1.2583 & 8.66 & 0.0000\
&&&

[singleVarModelsForPriceUsingCond]

![Scatterplot of the total auction price against the game’s condition. The least squares line is also shown.](06/figures/marioKartSingle/marioKartSingle)

[marioKartSingle]

Examine Figure [marioKartSingle]. Does the linear model seem ?[^7.2]

<span>Interpret the coefficient for the game’s condition in the model. Is this coefficient significantly different from 0?</span> Note that is a two-level categorical variable that takes value 1 when the game is new and value 0 when the game is used. So 10.90 means that the model predicts an extra \$10.90 for those games that are new versus those that are used. (See Section [categoricalPredictorsWithTwoLevels] for a review of the interpretation for two-level categorical predictor variables.) Examining the regression output in Table [singleVarModelsForPriceUsingCond], we can see that the p-value for is very close to zero, indicating there is strong evidence that the coefficient is different from zero when using this simple one-variable model.

### Including and assessing many variables in a model {#includingAndAssessingManyVariablesInAModel}

Sometimes there are underlying structures or relationships between predictor variables. For instance, new games sold on Ebay tend to come with more Wii wheels, which may have led to higher prices for those auctions. We would like to fit a model that includes all potentially important variables simultaneously. This would help us evaluate the relationship between a predictor variable and the outcome while controlling for the potential influence of other variables. This is the strategy used in **multiple regression**. While we remain cautious about making any causal interpretations using multiple regression, such models are a common first step in providing evidence of a causal connection.

We want to construct a model that accounts for not only the game condition, as in Section [twoSingleVariableModelsForMarioKartData], but simultaneously accounts for three other variables: , **duration**, and **wheels**.

$$\begin{aligned}
\widehat{\textbf{price}}
    &= \beta_0 + \beta_1\times \textbf{cond\_\hspace{0.3mm}new} +
        \beta_2\times \textbf{stock\_\hspace{0.3mm}photo} \notag \\
    &\qquad\  + \beta_3 \times  \textbf{duration} +
        \beta_4 \times  \textbf{wheels} \notag \\
\hat{y}
    &= \beta_0 + \beta_1 x_1 + \beta_2 x_2 +
        \beta_3 x_3 + \beta_4 x_4
\label{eqForMultipleRegrOfTotalPrForAllPredictors}\end{aligned}$$

In this equation, $y$ represents the total price, $x_1$ indicates whether the game is new, $x_2$ indicates whether a stock photo was used, $x_3$ is the duration of the auction, and $x_4$ is the number of Wii wheels included with the game. Just as with the single predictor case, a multiple regression model may be missing important components or it might not precisely represent the relationship between the outcome and the available explanatory variables. While no model is perfect, we wish to explore the possibility that this one may fit the data reasonably well.

We estimate the parameters $\beta_0$, $\beta_1$, ..., $\beta_4$ in the same way as we did in the case of a single predictor. We select $b_0$, $b_1$, ..., $b_4$ that minimize the sum of the squared residuals:

$$\begin{aligned}
\label{sumOfSqResInMultRegr}
SSE = e_1^2 + e_2^2 + \dots + e_{141}^2
    = \sum_{i=1}^{141} e_i^2
     = \sum_{i=1}^{141} \left(y_i - \hat{y}_i\right)^2\end{aligned}$$

Here there are 141 residuals, one for each observation. We typically use a computer to minimize the sum in Equation  and compute point estimates, as shown in the sample output in Table [outputForMultipleRegrOutputForAllPredictors]. Using this output, we identify the point estimates $b_i$ of each $\beta_i$, just as we did in the one-predictor case.

<span>rrrrr</span>

& & & &\
& Estimate & Std. Error & t value & Pr($>$$|$t$|$)\

& & & &\
(Intercept) & 36.2110 & 1.5140 & 23.92 & 0.0000\
cond\_

new & 5.1306 & 1.0511 & 4.88 & 0.0000\
stock\_

photo & 1.0803 & 1.0568 & 1.02 & 0.3085\
duration & -0.0268 & 0.1904 & -0.14 & 0.8882\
wheels & 7.2852 & 0.5547 & 13.13 & 0.0000\
&&&

[outputForMultipleRegrOutputForAllPredictors]

A multiple regression model is a linear model with many predictors. In general, we write the model as

$$\begin{aligned}
\hat{y} = \beta_0 + \beta_1 x_1 + \beta_2 x_2 + \cdots + \beta_k x_k %+ \epsilon\end{aligned}$$

when there are $k$ predictors. We often estimate the $\beta_i$ parameters using a computer.

[eqForMultipleRegrOfTotalPrForAllPredictorsWithCoefficients] Write out the model in Equation  using the point estimates from Table [outputForMultipleRegrOutputForAllPredictors]. How many predictors are there in this model?[^7.3]

What does $\beta_4$, the coefficient of variable $x_4$ (Wii wheels), represent? What is the point estimate of $\beta_4$?[^7.4]

[computeMultipleRegressionResidualForMarioKart] Compute the residual of the first observation in Table  using the equation identified in Guided Practice [eqForMultipleRegrOfTotalPrForAllPredictorsWithCoefficients]. [^7.5]

<span>We estimated a coefficient for in Section [twoSingleVariableModelsForMarioKartData] of $b_1 = 10.90$ with a standard error of $SE_{b_1} = 1.26$ when using simple linear regression. Why might there be a difference between that estimate and the one in the multiple regression setting?</span> [colinearityOfCondNewAndStockPhoto] If we examined the data carefully, we would see that some predictors are correlated. For instance, when we estimated the connection of the outcome **price** and predictor using simple linear regression, we were unable to control for other variables like the number of Wii wheels included in the auction. That model was biased by the confounding variable **wheels**. When we use both variables, this particular underlying and unintentional bias is reduced or eliminated (though bias from other confounding variables may still remain).

Example [colinearityOfCondNewAndStockPhoto] describes a common issue in multiple regression: correlation among predictor variables. We say the two predictor variables are **collinear** (pronounced as *co-linear*) when they are correlated, and this collinearity complicates model estimation. While it is impossible to prevent collinearity from arising in observational data, experiments are usually designed to prevent predictors from being collinear.

The estimated value of the intercept is 36.21, and one might be tempted to make some interpretation of this coefficient, such as, it is the model’s predicted price when each of the variables take value zero: the game is used, the primary image is not a stock photo, the auction duration is zero days, and there are no wheels included. Is there any value gained by making this interpretation?[^7.6]

### Adjusted $R^2$ as a better estimate of explained variance

We first used $R^2$ in Section [fittingALineByLSR] to determine the amount of variability in the response that was explained by the model:

$$\begin{aligned}
R^2 = 1 - \frac{\text{variability in residuals}}{\text{variability in the outcome}}
    = 1 - \frac{Var(e_i)}{Var(y_i)}\end{aligned}$$

where $e_i$ represents the residuals of the model and $y_i$ the outcomes. This equation remains valid in the multiple regression framework, but a small enhancement can often be even more informative.

[computeUnadjustedR2ForAllPredictorsInMarioKart] The variance of the residuals for the model given in Guided Practice [computeMultipleRegressionResidualForMarioKart] is 23.34, and the variance of the total price in all the auctions is 83.06. Calculate $R^2$ for this model.[^7.7]

This strategy for estimating $R^2$ is acceptable when there is just a single variable. However, it becomes less helpful when there are many variables. The regular $R^2$ is actually a biased estimate of the amount of variability explained by the model. To get a better estimate, we use the adjusted $R^2$.

The is computed as

$$\begin{aligned}
R_{adj}^{2} = 1-\frac{Var(e_i) / (n-k-1)}{Var(y_i) / (n-1)}
    = 1-\frac{Var(e_i)}{Var(y_i)} \times \frac{n-1}{n-k-1}\end{aligned}$$

where $n$ is the number of cases used to fit the model and $k$ is the number of predictor variables in the model.

Because $k$ is never negative, the adjusted $R^2$ will be smaller – often times just a little smaller – than the unadjusted $R^2$. The reasoning behind the adjusted $R^2$ lies in the associated with each variance.[^7.8]

There were $n=141$ auctions in the data set and $k=4$ predictor variables in the model. Use $n$, $k$, and the variances from Guided Practice [computeUnadjustedR2ForAllPredictorsInMarioKart] to calculate $R_{adj}^2$ for the Mario Kart model.[^7.9]

Suppose you added another predictor to the model, but the variance of the errors $Var(e_i)$ didn’t go down. What would happen to the $R^2$? What would happen to the adjusted $R^2$?

[^7.10]

## Model selection {#modelSelection}

The best model is not always the most complicated. Sometimes including variables that are not evidently important can actually reduce the accuracy of predictions. In this section we discuss model selection strategies, which will help us eliminate from the model variables that are less important.

In this section, and in practice, the model that includes all available explanatory variables is often referred to as the **full model**. Our goal is to assess whether the full model is the best model. If it isn’t, we want to identify a smaller model that is preferable.

### Identifying variables in the model that may not be helpful

Table [outputForMultipleRegrOutputForAllPredictors2] provides a summary of the regression output for the full model for the auction data. The last column of the table lists p-values that can be used to assess hypotheses of the following form:

-   $\beta_i = 0$ when the other explanatory variables are included in the model.

-   $\beta_i \neq 0$ when the other explanatory variables are included in the model.

<span>rrrrr</span>

& & & &\
& Estimate & Std. Error & t value & Pr($>$$|$t$|$)\

& & & &\
(Intercept) & 36.2110 & 1.5140 & 23.92 & 0.0000\
cond\_

new & 5.1306 & 1.0511 & 4.88 & 0.0000\
stock\_

photo & 1.0803 & 1.0568 & 1.02 & 0.3085\
duration & -0.0268 & 0.1904 & -0.14 & 0.8882\
wheels & 7.2852 & 0.5547 & 13.13 & 0.0000\

& & & &\
&

[outputForMultipleRegrOutputForAllPredictors2]

<span>The coefficient of has a $t$ test statistic of $T=4.88$ and a p-value for its corresponding hypotheses ($H_0: \beta_1 = 0$, $H_A: \beta_1 \neq 0$) of about zero. How can this be interpreted?</span> If we keep all the other variables in the model and add no others, then there is strong evidence that a game’s condition (new or used) has a real relationship with the total auction price.

<span>Is there strong evidence that using a stock photo is related to the total auction price?</span> The $t$ test statistic for is $T=1.02$ and the p-value is about 0.31. After accounting for the other predictors, there is not strong evidence that using a stock photo in an auction is related to the total price of the auction. We might consider removing the variable from the model.

Identify the p-values for both the **duration** and **wheels** variables in the model. Is there strong evidence supporting the connection of these variables with the total price in the model?[^7.11]

There is not statistically significant evidence that either the stock photo or duration variables contribute meaningfully to the model. Next we consider common strategies for pruning such variables from a model.

<span> The adjusted $R^2$ may be used as an alternative to p-values for model selection, where a higher adjusted $R^2$ represents a better model fit. For instance, we could compare two models using their adjusted $R^2$, and the model with the higher adjusted $R^2$ would be preferred. This approach tends to include more variables in the final model when compared to the p-value approach.</span>

### Two model selection strategies

Two common strategies for adding or removing variables in a multiple regression model are called *backward-selection* and *forward-selection*. These techniques are often referred to as **stepwise** model selection strategies, because they add or delete one variable at a time as they “step” through the candidate predictors. We will discuss these strategies in the context of the p-value approach. Alternatively, we could have employed an $R_{adj}^2$ approach.

The **backward-elimination** strategy starts with the model that includes all potential predictor variables. Variables are eliminated one-at-a-time from the model until only variables with statistically significant p-values remain. The strategy within each elimination step is to drop the variable with the largest p-value, refit the model, and reassess the inclusion of all variables.

<span>Results corresponding to the *full model* for the data are shown in Table [outputForMultipleRegrOutputForAllPredictors2]. How should we proceed under the backward-elimination strategy?</span> [backwardEliminationExampleWMarioKartData] There are two variables with coefficients that are not statistically different from zero: and **duration**. We first drop the **duration** variable since it has a larger corresponding p-value, *then we refit the model*. A regression summary for the new model is shown in Table [outputForMultipleRegrOutputForAllPredictorsButDuration].

In the new model, there is not strong evidence that the coefficient for is different from zero, even though the p-value decreased slightly, and the other p-values remain very small. Next, we again eliminate the variable with the largest non-significant p-value, , and refit the model. The updated regression summary is shown in Table [outputForMultipleRegrOutputForAllPredictorsButDurationAndStockPhoto].

In the latest model, we see that the two remaining predictors have statistically significant coefficients with p-values of about zero. Since there are no variables remaining that could be eliminated from the model, we stop. The final model includes only the and **wheels** variables in predicting the total auction price:

$$\begin{aligned}
\hat{y} \ &= \ b_0 + b_1x_1 + b_4x_4 \\
    &= \ 36.78 + 5.58x_1 + 7.23x_4\end{aligned}$$

where $x_1$ represents and $x_4$ represents **wheels**.

An alternative to using p-values in model selection is to use the adjusted $R^2$. At each elimination step, we refit the model without each of the variables up for potential elimination. For example, in the first step, we would fit four models, where each would be missing a different predictor. If one of these smaller models has a higher adjusted $R^2$ than our current model, we pick the smaller model with the largest adjusted $R^2$. We continue in this way until removing variables does not increase $R_{adj}^2$. Had we used the adjusted $R^2$ criteria, we would have kept the variable along with the and **wheels** variables.

<span>rrrrr</span>

& & & &\
& Estimate & Std. Error & t value & Pr($>$$|$t$|$)\

& & & &\
(Intercept) & 36.0483 & 0.9745 & 36.99 & 0.0000\
cond\_

new & 5.1763 & 0.9961 & 5.20 & 0.0000\
stock\_

photo & 1.1177 & 1.0192 & 1.10 & 0.2747\
wheels & 7.2984 & 0.5448 & 13.40 & 0.0000\

& & & &\
&&$df=137$

[outputForMultipleRegrOutputForAllPredictorsButDuration]

<span>rrrrr</span>

& & & &\
& Estimate & Std. Error & t value & Pr($>$$|$t$|$)\

& & & &\
(Intercept) & 36.7849 & 0.7066 & 52.06 & 0.0000\
cond\_

new & 5.5848 & 0.9245 & 6.04 & 0.0000\
wheels & 7.2328 & 0.5419 & 13.35 & 0.0000\

& & & &\
&&$df=138$

[outputForMultipleRegrOutputForAllPredictorsButDurationAndStockPhoto]

Notice that the p-value for changed a little from the full model (0.309) to the model that did not include the **duration** variable (0.275). It is common for p-values of one variable to change, due to collinearity, after eliminating a different variable. This fluctuation emphasizes the importance of refitting a model after each variable elimination step. The p-values tend to change dramatically when the eliminated variable is highly correlated with another variable in the model.

The **forward-selection** strategy is the reverse of the backward-elimination technique. Instead of eliminating variables one-at-a-time, we add variables one-at-a-time until we cannot find any variables that present strong evidence of their importance in the model.

<span>Construct a model for the data set using the forward-selection strategy.</span>[forwardEliminationExampleWMarioKartData] We start with the model that includes no variables. Then we fit each of the possible models with just one variable. That is, we fit the model including just the predictor, then the model including just the variable, then a model with just **duration**, and a model with just **wheels**. Each of the four models (yes, we fit four models!) provides a p-value for the coefficient of the predictor variable. Out of these four variables, the **wheels** variable had the smallest p-value. Since its p-value is less than 0.05 (the p-value was smaller than 2e-16), we add the Wii wheels variable to the model. Once a variable is added in forward-selection, it will be included in all models considered as well as the final model.

Since we successfully found a first variable to add, we consider adding another. We fit three new models: (1) the model including just the and **wheels** variables (output in Table [outputForMultipleRegrOutputForAllPredictorsButDurationAndStockPhoto]), (2) the model including just the and **wheels** variables, and (3) the model including only the **duration** and **wheels** variables. Of these models, the first had the lowest p-value for its new variable (the p-value corresponding to was 1.4e-08). Because this p-value is below 0.05, we add the variable to the model. Now the final model is guaranteed to include both the condition and wheels variables.

We must then repeat the process a third time, fitting two new models: (1) the model including the , , and **wheels** variables (output in Table [outputForMultipleRegrOutputForAllPredictorsButDuration]) and (2) the model including the **duration**, , and **wheels** variables. The p-value corresponding to in the first model (0.275) was smaller than the p-value corresponding to **duration** in the second model (0.682). However, since this smaller p-value was not below 0.05, there was not strong evidence that it should be included in the model. Therefore, neither variable is added and we are finished.

The final model is the same as that arrived at using the backward-selection strategy.

<span>As before, we could have used the $R_{adj}^2$ criteria instead of examining p-values in selecting variables for the model. Rather than look for variables with the smallest p-value, we look for the model with the largest $R_{adj}^2$. What would the result of forward-selection be using the adjusted $R^2$ approach?</span> Using the forward-selection strategy, we start with the model with no predictors. Next we look at each model with a single predictor. If one of these models has a larger $R_{adj}^2$ than the model with no variables, we use this new model. We repeat this procedure, adding one variable at a time, until we cannot find a model with a larger $R_{adj}^2$. If we had done the forward-selection strategy using $R_{adj}^2$, we would have arrived at the model including , , and **wheels**, which is a slightly larger model than we arrived at using the p-value approach and the same model we arrived at using the adjusted $R^2$ and backwards-elimination.

<span> The backward-elimination strategy begins with the largest model and eliminates variables one-by-one until we are satisfied that all remaining variables are important to the model. The forward-selection strategy starts with no variables included in the model, then it adds in variables according to their importance until no other important variables are found.</span>

There is no guarantee that the backward-elimination and forward-selection strategies will arrive at the same final model using the p-value or adjusted $R^2$ methods. If the backwards-elimination and forward-selection strategies are both tried and they arrive at different models, choose the model with the larger $R_{adj}^2$ as a tie-breaker; other tie-break options exist but are beyond the scope of this book.

It is generally acceptable to use just one strategy, usually backward-elimination with either the p-value or adjusted $R^2$ criteria. However, before reporting the model results, we must verify the model conditions are reasonable.

## Checking model assumptions using graphs {#multipleRegressionModelAssumptions}

Multiple regression methods using the model

$$\begin{aligned}
\hat{y} &= \beta_0 + \beta_1x_1 + \beta_2x_2 + \cdots + \beta_kx_k\end{aligned}$$

generally depend on the following four assumptions:

1.  the residuals of the model are nearly normal,

2.  the variability of the residuals is nearly constant,

3.  the residuals are independent, and

4.  each variable is linearly related to the outcome.

Simple and effective plots can be used to check each of these assumptions. We will consider the model for the auction data that uses the game condition and number of wheels as predictors. The plotting methods presented here may also be used to check the conditions for the models introduced in Chapter [linRegrForTwoVar].

Normal probability plot.

:   A normal probability plot of the residuals is shown in Figure [mkDiagnosticNormalQuantilePlot]. While the plot exhibits some minor irregularities, there are no outliers that might be cause for concern. In a normal probability plot for residuals, we tend to be most worried about residuals that appear to be outliers, since these indicate long tails in the distribution of residuals.

    ![A normal probability plot of the residuals is helpful in identifying observations that might be outliers.](06/figures/marioKartDiagnostics/mkDiagnosticNormalQuantilePlot)

    [mkDiagnosticNormalQuantilePlot]

Absolute values of residuals against fitted values.

:   A plot of the absolute value of the residuals against their corresponding fitted values ($\hat{y}_i$) is shown in Figure [mkDiagnosticEvsAbsF]. This plot is helpful to check the condition that the variance of the residuals is approximately constant. We don’t see any obvious deviations from constant variance in this example.

    ![Comparing the absolute value of the residuals against the fitted values ($\hat{y}_i$) is helpful in identifying deviations from the constant variance assumption.](06/figures/marioKartDiagnostics/mkDiagnosticEvsAbsF)

    [mkDiagnosticEvsAbsF]

Residuals in order of their data collection.

:   A plot of the residuals in the order their corresponding auctions were observed is shown in Figure [mkDiagnosticInOrder]. Such a plot is helpful in identifying any connection between cases that are close to one another, e.g. we could look for declining prices over time or if there was a time of the day when auctions tended to fetch a higher price. Here we see no structure that indicates a problem.[^7.12]

    ![Plotting residuals in the order that their corresponding observations were collected helps identify connections between successive observations. If it seems that consecutive observations tend to be close to each other, this indicates the independence assumption of the observations would fail.](06/figures/marioKartDiagnostics/mkDiagnosticInOrder)

    [mkDiagnosticInOrder]

Residuals against each predictor variable.

:   We consider a plot of the residuals against the variable and the residuals against the **wheels** variable. These plots are shown in Figure [mkDiagnosticEvsVariables]. For the two-level condition variable, we are guaranteed not to see any remaining trend, and instead we are checking that the variability doesn’t fluctuate across groups. In this example, when we consider the residuals against the **wheels** variable, we see some possible structure. There appears to be curvature in the residuals, indicating the relationship is probably not linear.

    ![In the two-level variable for the game’s condition, we check for differences in distribution shape or variability. For numerical predictors, we also check for trends or other structure. We see some slight bowing in the residuals against the **wheels** variable.](06/figures/marioKartDiagnostics/mkDiagnosticEvsVariables)

    [mkDiagnosticEvsVariables]

It is necessary to summarize diagnostics for any model fit. If the diagnostics support the model assumptions, this would improve credibility in the findings. If the diagnostic assessment shows remaining underlying structure in the residuals, we should try to adjust the model to account for that structure. If we are unable to do so, we may still report the model but must also note its shortcomings. In the case of the auction data, we report that there may be a nonlinear relationship between the total price and the number of wheels included for an auction. This information would be important to buyers and sellers; omitting this information could be a setback to the very people who the model might assist.

<span> The truth is that no model is perfect. However, even imperfect models can be useful. Reporting a flawed model can be reasonable so long as we are clear and report the model’s shortcomings.</span>

<span>Don’t report results when assumptions are grossly violated</span> <span>While there is a little leeway in model assumptions, don’t go too far. If model assumptions are very clearly violated, consider a new model, even if it means learning more statistical methods or hiring someone who can help.</span>

Confidence intervals for coefficients in multiple regression can be computed using the same formula as in the single predictor model:

$$\begin{aligned}
b_i \ \pm\ t_{df}^{\star}SE_{b_{i}}\end{aligned}$$

where $t_{df}^{\star}$ is the appropriate $t$ value corresponding to the confidence level and model degrees of freedom, $df=n-k-1$.

## Logistic regression {#logisticRegression}

In this section we introduce **logistic regression** as a tool for building models when there is a categorical response variable with two levels. Logistic regression is a type of **generalized linear model** (GLM) for response variables where regular multiple regression does not work very well. In particular, the response variable in these settings often takes a form where residuals look completely different from the normal distribution.

GLMs can be thought of as a two-stage modeling approach. We first model the response variable using a probability distribution, such as the binomial or Poisson distribution. Second, we model the parameter of the distribution using a collection of predictors and a special form of multiple regression.

In Section [logisticRegression] we will revisit the **email** data set from Chapter [introductionToData]. These emails were collected from a single email account, and we will work on developing a basic spam filter using these data. The response variable, **spam**, has been encoded to take value 0 when a message is not spam and 1 when it is spam. Our task will be to build an appropriate model that classifies messages as spam or not spam using email characteristics coded as predictor variables. While this model will not be the same as those used in large-scale spam filters, it shares many of the same features.

### Email data

The **email** data set was first presented in Chapter [introductionToData] with a relatively small number of variables. In fact, there are many more variables available that might be useful for classifying spam. Descriptions of these variables are presented in Table [emailVariables]. The **spam** variable will be the outcome, and the other 10 variables will be the model predictors. While we have limited the predictors used in this section to be categorical variables (where many are represented as indicator variables), numerical predictors may also be used in logistic regression. See the footnote for an additional discussion on this topic.[^7.13]

  <span>**variable**</span>   <span>**description**</span>
  --------------------------- ----------------------------------------------------------------------------------------------------
  **spam**                    Specifies whether the message was spam.
                              An indicator variable for if more than one person was listed in the *To* field of the email.
  **cc**                      An indicator for if someone was CCed on the email.
  **attach**                  An indicator for if there was an attachment, such as a document or image.
  **dollar**                  An indicator for if the word “dollar” or dollar symbol (\$) appeared in the email.
  **winner**                  An indicator for if the word “winner” appeared in the email message.
  **inherit**                 An indicator for if the word “inherit” (or a variation, like “inheritance”) appeared in the email.
  **password**                An indicator for if the word “password” was present in the email.
  **format**                  Indicates if the email contained special formatting, such as bolding, tables, or links
                              Indicates whether “Re:” was included at the start of the email subject.
                              Indicates whether any exclamation point was included in the email subject.

  : Descriptions for 11 variables in the **email** data set. Notice that all of the variables are indicator variables, which take the value 1 if the specified characteristic is present and 0 otherwise.

[emailVariables]

### Modeling the probability of an event {#modelingTheProbabilityOfAnEvent}

The outcome variable for a GLM is denoted by $Y_i$, where the index $i$ is used to represent observation $i$. In the email application, $Y_i$ will be used to represent whether email $i$ is spam ($Y_i=1$) or not ($Y_i=0$).

The predictor variables are represented as follows: $x_{1,i}$ is the value of variable 1 for observation $i$, $x_{2,i}$ is the value of variable 2 for observation $i$, and so on.

Logistic regression is a generalized linear model where the outcome is a two-level categorical variable. The outcome, $Y_i$, takes the value 1 (in our application, this represents a spam message) with probability $p_i$ and the value 0 with probability $1-p_i$. It is the probability $p_i$ that we model in relation to the predictor variables.

The logistic regression model relates the probability an email is spam ($p_i$) to the predictors $x_{1,i}$, $x_{2,i}$, ..., $x_{k,i}$ through a framework much like that of multiple regression:

$$\begin{aligned}
transformation(p_{i}) = \beta_0 + \beta_1x_{1,i} + \beta_2 x_{2,i} + \cdots \beta_k x_{k,i}
\label{linkTransformationEquation}\end{aligned}$$

We want to choose a transformation in Equation  that makes practical and mathematical sense. For example, we want a transformation that makes the range of possibilities on the left hand side of Equation  equal to the range of possibilities for the right hand side; if there was no transformation for this equation, the left hand side could only take values between 0 and 1, but the right hand side could take values outside of this range. A common transformation for $p_i$ is the **logit transformation**, which may be written as

$$\begin{aligned}
logit(p_i) = \log_{e}\left( \frac{p_i}{1-p_i} \right)\end{aligned}$$

The logit transformation is shown in Figure [logitTransformationFigureHoriz]. Below, we rewrite Equation  using the logit transformation of $p_i$:

$$\begin{aligned}
\log_{e}\left( \frac{p_i}{1-p_i} \right)
    = \beta_0 + \beta_1 x_{1,i} + \beta_2 x_{2,i} + \cdots + \beta_k x_{k,i}\end{aligned}$$

In our spam example, there are 10 predictor variables, so $k = 10$. This model isn’t very intuitive, but it still has some resemblance to multiple regression, and we can fit this model using software. In fact, once we look at results from software, it will start to feel like we’re back in multiple regression, even if the interpretation of the coefficients is more complex.

![Values of $p_i$ against values of $logit(p_i)$.](06/figures/logitTransformationFigureHoriz/logitTransformationFigureHoriz)

[logitTransformationFigureHoriz]

Here we create a spam filter with a single predictor: . This variable indicates whether more than one email address was listed in the *To* field of the email. The following logistic regression model was fit using statistical software:

$$\begin{aligned}
\log\left( \frac{p_i}{1-p_i} \right) = -2.12 - 1.81\times\text{\textbf{to\_\hspace{0.3mm}multiple}}\end{aligned}$$

If an email is randomly selected and it has just one address in the *To* field, what is the probability it is spam? What if more than one address is listed in the *To* field?

[logisticExampleWithToMultiple] If there is only one email in the *To* field, then takes value 0 and the right side of the model equation equals -2.12. Solving for $p_i$: $\frac{e^{-2.12}}{1 + e^{-2.12}} = 0.11$. Just as we labeled a fitted value of $y_i$ with a “hat” in single-variable and multiple regression, we will do the same for this probability: $\hat{p}_i = 0.11$.

If there is more than one address listed in the *To* field, then the right side of the model equation is $-2.12 - 1.81\times1 = -3.93$, which corresponds to a probability $\hat{p}_i = 0.02$.

Notice that we could examine -2.12 and -3.93 in Figure [logitTransformationFigureHoriz] to estimate the probability before formally calculating the value.

To convert from values on the regression-scale (e.g. -2.12 and -3.93 in Example [logisticExampleWithToMultiple]), use the following formula, which is the result of solving for $p_i$ in the regression model:

$$\begin{aligned}
p_i
    = \frac{e^{\beta_0 + \beta_1 x_{1,i}+\cdots+\beta_k x_{k,i}}}
        {\ 1\ \ +\ \ e^{\beta_0 + \beta_1 x_{1,i}+\cdots+\beta_k x_{k,i}}\ }\end{aligned}$$

As with most applied data problems, we substitute the point estimates for the parameters (the $\beta_i$) so that we may make use of this formula. In Example [logisticExampleWithToMultiple], the probabilities were calculated as

$$\begin{aligned}
&\frac{\ e^{-2.12}\ }{\ 1\ +\ e^{-2.12}\ } = 0.11 && \frac{\ e^{-2.12 - 1.81}\ }{\ 1\ +\ e^{-2.12 - 1.81}\ } = 0.02\end{aligned}$$

While the information about whether the email is addressed to multiple people is a helpful start in classifying email as spam or not, the probabilities of 11% and 2% are not dramatically different, and neither provides very strong evidence about which particular email messages are spam. To get more precise estimates, we’ll need to include many more variables in the model.

We used statistical software to fit the logistic regression model with all ten predictors described in Table [emailVariables]. Like multiple regression, the result may be presented in a summary table, which is shown in Table [emailLogisticModelResults]. The structure of this table is almost identical to that of multiple regression; the only notable difference is that the p-values are calculated using the normal distribution rather than the $t$ distribution.

<span>rrrrr</span>

& & & &\
& Estimate & Std. Error & z value & Pr($>$$|$z$|$)\

& & & &\
(Intercept) & -0.8362 & 0.0962 & -8.69 & 0.0000\
to\_

multiple & -2.8836 & 0.3121 & -9.24 & 0.0000\
winner & 1.7038 & 0.3254 & 5.24 & 0.0000\
format & -1.5902 & 0.1239 & -12.84 & 0.0000\
re\_

subj & -2.9082 & 0.3708 & -7.84 & 0.0000\
exclaim\_

subj & 0.1355 & 0.2268 & 0.60 & 0.5503\
cc & -0.4863 & 0.3054 & -1.59 & 0.1113\
attach & 0.9790 & 0.2170 & 4.51 & 0.0000\
dollar & -0.0582 & 0.1589 & -0.37 & 0.7144\
inherit & 0.2093 & 0.3197 & 0.65 & 0.5127\
password & -1.4929 & 0.5295 & -2.82 & 0.0048\

[emailLogisticModelResults]

Just like multiple regression, we could trim some variables from the model using the p-value. Using backwards elimination with a p-value cutoff of 0.05 (start with the full model and trim the predictors with p-values greater than 0.05), we ultimately eliminate the , **dollar**, **inherit**, and **cc** predictors. The remainder of this section will rely on this smaller model, which is summarized in Table [emailLogisticReducedModel].

<span>rrrrr</span>

& & & &\
& Estimate & Std. Error & z value & Pr($>$$|$z$|$)\

& & & &\
(Intercept) & -0.8595 & 0.0910 & -9.44 & 0.0000\
to\_

multiple & -2.8372 & 0.3092 & -9.18 & 0.0000\
winner & 1.7370 & 0.3218 & 5.40 & 0.0000\
format & -1.5569 & 0.1207 & -12.90 & 0.0000\
re\_

subj & -3.0482 & 0.3630 & -8.40 & 0.0000\
attach & 0.8643 & 0.2042 & 4.23 & 0.0000\
password & -1.4871 & 0.5290 & -2.81 & 0.0049\

[emailLogisticReducedModel]

Examine the summary of the reduced model in Table [emailLogisticReducedModel], and in particular, examine the row. Is the point estimate the same as we found before, -1.81, or is it different? Explain why this might be.[^7.14]

Point estimates will generally change a little – and sometimes a lot – depending on which other variables are included in the model. This is usually due to colinearity in the predictor variables. We previously saw this in the Ebay auction example when we compared the coefficient of in a single-variable model and the corresponding coefficient in the multiple regression model that used three additional variables (see Sections [twoSingleVariableModelsForMarioKartData] and [includingAndAssessingManyVariablesInAModel]).

<span>Spam filters are built to be automated, meaning a piece of software is written to collect information about emails as they arrive, and this information is put in the form of variables. These variables are then put into an algorithm that uses a statistical model, like the one we’ve fit, to classify the email. Suppose we write software for a spam filter using the reduced model shown in Table [emailLogisticReducedModel]. If an incoming email has the word “winner” in it, will this raise or lower the model’s calculated probability that the incoming email is spam?</span> [exampleForSpamAndWinner] The estimated coefficient of **winner** is positive (1.7370). A positive coefficient estimate in logistic regression, just like in multiple regression, corresponds to a positive association between the predictor and response variables when accounting for the other variables in the model. Since the response variable takes value 1 if an email is spam and 0 otherwise, the positive coefficient indicates that the presence of “winner” in an email raises the model probability that the message is spam.

<span>Suppose the same email from Example [exampleForSpamAndWinner] was in HTML format, meaning the **format** variable took value 1. Does this characteristic increase or decrease the probability that the email is spam according to the model?</span>[exampleForSpamAndFormat] Since HTML corresponds to a value of 1 in the **format** variable and the coefficient of this variable is negative (-1.5569), this would lower the probability estimate returned from the model.

### Practical decisions in the email application

Examples [exampleForSpamAndWinner] and [exampleForSpamAndFormat] highlight a key feature of logistic and multiple regression. In the spam filter example, some email characteristics will push an email’s classification in the direction of spam while other characteristics will push it in the opposite direction.

If we were to implement a spam filter using the model we have fit, then each future email we analyze would fall into one of three categories based on the email’s characteristics:

1.  The email characteristics generally indicate the email is not spam, and so the resulting probability that the email is spam is quite low, say, under 0.05.

2.  The characteristics generally indicate the email is spam, and so the resulting probability that the email is spam is quite large, say, over 0.95.

3.  The characteristics roughly balance each other out in terms of evidence for and against the message being classified as spam. Its probability falls in the remaining range, meaning the email cannot be adequately classified as spam or not spam.

If we were managing an email service, we would have to think about what should be done in each of these three instances. In an email application, there are usually just two possibilities: filter the email out from the regular inbox and put it in a “spambox”, or let the email go to the regular inbox.

The first and second scenarios are intuitive. If the evidence strongly suggests a message is not spam, send it to the inbox. If the evidence strongly suggests the message is spam, send it to the spambox. How should we handle emails in the third category?[^7.15]

Suppose we apply the logistic model we have built as a spam filter and that 100 messages are placed in the spambox over 3 months. If we used the guidelines above for putting messages into the spambox, about how many legitimate (non-spam) messages would you expect to find among the 100 messages?[^7.16]

Almost any classifier will have some error. In the spam filter guidelines above, we have decided that it is okay to allow up to 5% of the messages in the spambox to be real messages. If we wanted to make it a little harder to classify messages as spam, we could use a cutoff of 0.99. This would have two effects. Because it raises the standard for what can be classified as spam, it reduces the number of good emails that are classified as spam. However, it will also fail to correctly classify an increased fraction of spam messages. No matter the complexity and the confidence we might have in our model, these practical considerations are absolutely crucial to making a helpful spam filter. Without them, we could actually do more harm than good by using our statistical model.

### Diagnostics for the email classifier

There are two key conditions for fitting a logistic regression model:

1.  Each predictor $x_i$ is linearly related to logit$(p_i)$ if all other predictors are held constant.

2.  Each outcome $Y_i$ is independent of the other outcomes.

The first condition of the logistic regression model is not easily checked without a fairly sizable amount of data. Luckily, we have 3,921 emails in our data set! Let’s first visualize these data by plotting the true classification of the emails against the model’s fitted probabilities, as shown in Figure [logisticModelPredict]. The vast majority of emails (spam or not) still have fitted probabilities below 0.5.

![The predicted probability that each of the 3,912 emails is spam is classified by their grouping, spam or not. Noise (small, random vertical shifts) have been added to each point so that points with nearly identical values aren’t plotted exactly on top of one another. This makes it possible to see more observations.](06/figures/logisticModel/logisticModelPredict)

[logisticModelPredict]

This may at first seem very discouraging: we have fit a logistic model to create a spam filter, but no emails have a fitted probability of being spam above 0.75. Don’t despair; we will discuss ways to improve the model through the use of better variables in Section [improvingTheSetOfVariablesForASpamFilter].

We’d like to assess the quality of our model. For example, we might ask: if we look at emails that we modeled as having a 10% chance of being spam, do we find about 10% of them actually are spam? To help us out, we’ll borrow an advanced statistical method called **natural splines** that estimates the local probability over the region 0.00 to 0.75 (the largest predicted probability was 0.73, so we avoid extrapolating). All you need to know about natural splines to understand what we are doing is that they are used to fit flexible lines rather than straight lines.

The curve fit using natural splines is shown in Figure [logisticModelSpline] as a solid black line. If the logistic model fits well, the curve should closely follow the dashed $y=x$ line. We have added shading to represent the confidence bound for the curved line to clarify what fluctuations might plausibly be due to chance. Even with this confidence bound, there are weaknesses in the first model assumption. The solid curve and its confidence bound dips below the dashed line from about 0.1 to 0.3, and then it drifts above the dashed line from about 0.35 to 0.55. These deviations indicate the model relating the parameter to the predictors does not closely resemble the true relationship.

![The solid black line provides the empirical estimate of the probability for observations based on their predicted probabilities (confidence bounds are also shown for this line), which is fit using natural splines. A small amount of noise was added to the observations in the plot to allow more observations to be seen.](06/figures/logisticModel/logisticModelSpline)

[logisticModelSpline]

We could evaluate the second logistic regression model assumption – independence of the outcomes – using the model residuals. The residuals for a logistic regression model are calculated the same way as with multiple regression: the observed outcome minus the expected outcome. For logistic regression, the expected value of the outcome is the fitted probability for the observation, and the residual may be written as

$$\begin{aligned}
e_i = Y_i - \hat{p}_i\end{aligned}$$

We could plot these residuals against a variety of variables or in their order of collection, as we did with the residuals in multiple regression. However, since the model will need to be revised to effectively classify spam and you have already seen similar residual plots in Section [multipleRegressionModelAssumptions], we won’t investigate the residuals here.

### Improving the set of variables for a spam filter {#improvingTheSetOfVariablesForASpamFilter}

If we were building a spam filter for an email service that managed many accounts (e.g. Gmail or Hotmail), we would spend much more time thinking about additional variables that could be useful in classifying emails as spam or not. We also would use transformations or other techniques that would help us include strongly skewed numerical variables as predictors.

Take a few minutes to think about additional variables that might be useful in identifying spam. Below is a list of variables we think might be useful:

1.  An indicator variable could be used to represent whether there was prior two-way correspondence with a message’s sender. For instance, if you sent a message to john@example.com and then John sent you an email, this variable would take value 1 for the email that John sent. If you had never sent John an email, then the variable would be set to 0.

2.  A second indicator variable could utilize an account’s past spam flagging information. The variable could take value 1 if the sender of the message has previously sent messages flagged as spam.

3.  A third indicator variable could flag emails that contain links included in previous spam messages. If such a link is found, then set the variable to 1 for the email. Otherwise, set it to 0.

The variables described above take one of two approaches. Variable (1) is specially designed to capitalize on the fact that spam is rarely sent between individuals that have two-way communication. Variables (2) and (3) are specially designed to flag common spammers or spam messages. While we would have to verify using the data that each of the variables is effective, these seem like promising ideas.

Table [emailTableOfSpamAnd] shows a contingency table for spam and also for the new variable described in (1) above. If we look at the 1,090 emails where there was correspondence with the sender in the preceding 30 days, not one of these message was spam. This suggests variable (1) would be very effective at accurately classifying some messages as not spam. With this single variable, we would be able to send about 28% of messages through to the inbox with confidence that almost none are spam.

<span>lrrrr</span> & &\
 &  

&  

&&  

Total\

& & & &\
 & 367 & 0 && 367\

  & 2464 & 1090 && 3554\

& & & &\
Total & 2831 & 1090 && 3921\

[emailTableOfSpamAnd]

The variables described in (2) and (3) would provide an excellent foundation for distinguishing messages coming from known spammers or messages that take a known form of spam. To utilize these variables, we would need to build databases: one holding email addresses of known spammers, and one holding URLs found in known spam messages. Our access to such information is limited, so we cannot implement these two variables in this textbook. However, if we were hired by an email service to build a spam filter, these would be important next steps.

In addition to finding more and better predictors, we would need to create a customized logistic regression model for each email account. This may sound like an intimidating task, but its complexity is not as daunting as it may at first seem. We’ll save the details for a statistics course where computer programming plays a more central role.

For what is the extremely challenging task of classifying spam messages, we have made a lot of progress. We have seen that simple email variables, such as the format, inclusion of certain words, and other circumstantial characteristics, provide helpful information for spam classification. Many challenges remain, from better understanding logistic regression to carrying out the necessary computer programming, but completing such a task is very nearly within your reach.

[^7.1]: Diez DM, Barr CD, and Çetinkaya-Rundel M. 2012. *openintro*: OpenIntro data sets and supplemental functions. [cran.r-project.org/web/packages/openintro](http://cran.r-project.org/web/packages/openintro).

[^7.2]: Yes. Constant variability, nearly normal residuals, and linearity all appear reasonable.

[^7.3]: $\hat{y} = 36.21 + 5.13x_1 + 1.08x_2 - 0.03x_3 + 7.29x_4$, and there are $k=4$ predictor variables.

[^7.4]: It is the average difference in auction price for each additional Wii wheel included when holding the other variables constant. The point estimate is $b_4 = 7.29$.

[^7.5]: $e_i = y_i - \hat{y_i} = 51.55 - 49.62 = 1.93$, where 49.62 was computed using the variables values from the observation and the equation identified in Guided Practice [eqForMultipleRegrOfTotalPrForAllPredictorsWithCoefficients].

[^7.6]: Three of the variables (, , and **wheels**) do take value 0, but the auction duration is always one or more days. If the auction is not up for any days, then no one can bid on it! That means the total auction price would always be zero for such an auction; the interpretation of the intercept in this setting is not insightful.

[^7.7]: $R^2 = 1 - \frac{23.34}{83.06} = 0.719$.

[^7.8]: In multiple regression, the degrees of freedom associated with the variance of the estimate of the residuals is $n-k-1$, not $n-1$. For instance, if we were to make predictions for new data using our current model, we would find that the unadjusted $R^2$ is an overly optimistic estimate of the reduction in variance in the response, and using the degrees of freedom in the adjusted $R^2$ formula helps correct this bias.

[^7.9]: $R_{adj}^2 = 1 - \frac{23.34}{83.06}\times \frac{141-1}{141-4-1} = 0.711$.

[^7.10]: The unadjusted $R^2$ would stay the same and the adjusted $R^2$ would go down.

[^7.11]: The p-value for the auction duration is 0.8882, which indicates that there is not statistically significant evidence that the duration is related to the total auction price when accounting for the other variables. The p-value for the Wii wheels variable is about zero, indicating that this variable is associated with the total auction price.

[^7.12]: An especially rigorous check would use **time series** methods. For instance, we could check whether consecutive residuals are correlated. Doing so with these residuals yields no statistically significant correlations.

[^7.13]: Recall from Chapter [linRegrForTwoVar] that if outliers are present in predictor variables, the corresponding observations may be especially influential on the resulting model. This is the motivation for omitting the numerical variables, such as the number of characters and line breaks in emails, that we saw in Chapter [introductionToData]. These variables exhibited extreme skew. We could resolve this issue by transforming these variables (e.g. using a log-transformation), but we will omit this further investigation for brevity.

[^7.14]: The new estimate is different: -2.87. This new value represents the estimated coefficient when we are also accounting for other variables in the logistic regression model.

[^7.15]: In this particular application, we should err on the side of sending more mail to the inbox rather than mistakenly putting good messages in the spambox. So, in summary: emails in the first and last categories go to the regular inbox, and those in the second scenario go to the spambox.

[^7.16]: First, note that we proposed a cutoff for the predicted probability of 0.95 for spam. In a worst case scenario, all the messages in the spambox had the minimum probability equal to about 0.95. Thus, we should expect to find about 5 or fewer legitimate messages among the 100 messages placed in the spambox.
